#!/usr/bin/env node

const fs = require("fs");
const Path = require("path");
const GMailDispatcher = require("../lib/dispatchers/gmail");

const cmd = require("commander");
const cli = cmd.version("0.1.0", "-v --version");

cli.arguments('<credentials> [code]')
   .action(async (credentialsPath, code=null) => {
       const fullCredentialsPath = Path.resolve(process.cwd(), credentialsPath);
       const credentialsFile = fs.readFileSync(fullCredentialsPath, "utf8");
       const credentials = JSON.parse(credentialsFile);
       if (!code) {
           const authURL = GMailDispatcher.getNewAuthURL(credentials);
           console.log(`1) Visit the following URL to authorize the app:`);
           console.log(`   ${authURL}`);
           console.log(`2) Rerun this command with credentials-path parameter followed by the obtained code`);       
       } else {
          const tokens = await GMailDispatcher.getTokens(credentials, code);
          console.log(tokens);
       }
   });

cli.parse( process.argv );
